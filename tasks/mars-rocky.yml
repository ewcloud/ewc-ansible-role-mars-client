---
- name: Ensure EPEL repo is enabled
  ansible.builtin.dnf:
    name: epel-release
    state: latest

- name: Extra repo name
  ansible.builtin.set_fact:
    extra_repo: "{{ 'crb' if ansible_distribution_major_version|int > 8 else 'powertools' }}" 

- name: "Check if {{ extra_repo }} is enabled"
  ansible.builtin.command:
    cmd: "dnf repolist {{ extra_repo }} --enabled"
  register: repolist
  changed_when: false

- name: "Enable {{ extra_repo }} repository"
  ansible.builtin.command:
    cmd: "dnf config-manager --enable {{ extra_repo }}"
  when: extra_repo not in repolist.stdout

- name: Copy GPG Key to Remote Host
  ansible.builtin.copy:
    src: ewc-rocky-gpg-key
    dest: /etc/pki/rpm-gpg/RPM-GPG-KEY-ewc-ecmwf-packages
    mode: '0644'

- name: Import EWC Packages GPG Key
  ansible.builtin.rpm_key:
    state: present
    key: /etc/pki/rpm-gpg/RPM-GPG-KEY-ewc-ecmwf-packages

- name: Add ECMWF repository
  ansible.builtin.yum_repository:
    name: ecmwf
    description: ECMWF Repository
    baseurl: "{{ repo_base }}/repository/private-rocky-{{ repo_suffix }}/{{ ansible_distribution_major_version }}/{{ ansible_distribution_version.split('.')[1] }}/rpms"
    gpgcheck: true
    enabled: true

- name: Check if MARS servers can be reached (ECMWF only)
  ansible.builtin.getent:
    database: hosts
    key: marsod.ecmwf.int
  register: marsod_lookup
  ignore_errors: true

- name: Trust the traffic coming from the ECMWF LAN in the local firewall
  ansible.posix.firewalld:
    zone: trusted
    source: 10.0.0.0/8
    state: enabled
    permanent: true
    immediate: true
  when: marsod_lookup.ansible_facts.getent_hosts is defined 

- name: "Install MARS client"
  ansible.builtin.dnf:
    name: mars-client-cloud
    state: latest
